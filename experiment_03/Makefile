# Makefile - æ”¯æŒè·³è¿‡æ­¥éª¤ & è™šæ‹Ÿç¯å¢ƒ
.PHONY: data features model evaluate all sweep clean help

# ========================
# ğŸ”§ é…ç½®åŒº
# ========================

# å®šä¹‰ Python è§£é‡Šå™¨è·¯å¾„ï¼ˆæ ¹æ®æ“ä½œç³»ç»Ÿè°ƒæ•´ï¼‰
# Windows:
PYTHON := ../.venv/Scripts/python.exe
# Linux/macOSï¼ˆå–æ¶ˆæ³¨é‡Šï¼‰:
# PYTHON := .venv/bin/python

# é»˜è®¤å‚æ•°
N_ESTIMATORS ?= 100
MAX_DEPTH ?= 5

# æ§åˆ¶æ˜¯å¦è·³è¿‡æŸäº›æ­¥éª¤ï¼ˆé»˜è®¤ä¸è·³è¿‡ï¼‰
SKIP_DATA ?= false
SKIP_FEATURES ?= false
SKIP_MODEL ?= false


# ========================
# ğŸ“¦ æ•°æ®ä¸ç‰¹å¾
# ========================

# Step 1: è·å–æ•°æ®
data:
	@echo "ğŸ” Step 1: è·å–åŸå§‹æ•°æ®"
	@if [ "$(SKIP_DATA)" = "true" ]; then \
		echo "â­ï¸  SKIP_DATA=trueï¼Œè·³è¿‡æ•°æ®è·å–æ­¥éª¤"; \
	else \
		"$(PYTHON)" src/data/make_dataset.py; \
	fi

# Step 2: ç‰¹å¾å·¥ç¨‹
features: data
	@echo "ğŸ”§ Step 2: æ„å»ºç‰¹å¾"
	@if [ "$(SKIP_FEATURES)" = "true" ]; then \
		echo "â­ï¸  SKIP_FEATURES=trueï¼Œè·³è¿‡ç‰¹å¾å·¥ç¨‹æ­¥éª¤"; \
	else \
		"$(PYTHON)" src/features/build_features.py; \
	fi


# ========================
# ğŸ¤– æ¨¡å‹è®­ç»ƒä¸è¯„ä¼°
# ========================

# Step 3: è®­ç»ƒæ¨¡å‹
model: features
	@echo "ğŸ¤– Step 3-1: è®­ç»ƒæ¨¡å‹ n_estimators=$(N_ESTIMATORS), max_depth=$(MAX_DEPTH)"
	@if [ "$(SKIP_MODEL)" = "true" ]; then \
		echo "â­ï¸  SKIP_FEATURES=trueï¼Œè·³è¿‡ç‰¹å¾å·¥ç¨‹æ­¥éª¤"; \
	else \
		"$(PYTHON)" src/models/train_model.py --n_estimators $(N_ESTIMATORS) --max_depth $(MAX_DEPTH); \
	fi

# Step 4: æ¨¡å‹è¯„ä¼°
evaluate: model
	@echo "ğŸ“ˆ Step 4: è¯„ä¼°æ¨¡å‹ n_estimators=$(N_ESTIMATORS), max_depth=$(MAX_DEPTH)"
	"$(PYTHON)" src/evaluate/evaluate.py --n_estimators $(N_ESTIMATORS) --max_depth $(MAX_DEPTH)


# Step 5: å¤šå‚æ•°æ‰«æè®­ç»ƒ+è¯„ä¼°
sweep: features
	@echo "ğŸ§  Step 3-2: å¼€å§‹å‚æ•°æ‰«æ"
	bash src/scripts/sweep.sh "$(PYTHON)"


# ========================
# ğŸš€ å…¨æµç¨‹ & å·¥å…·
# ========================

# å…¨æµç¨‹ï¼ˆé»˜è®¤å‚æ•°ï¼‰
all: data features model evaluate
	@echo "ğŸ‰ è®­ç»ƒæµæ°´çº¿æ‰§è¡Œå®Œæˆï¼"


# æ¸…ç†æ•°æ®
clean:
	@echo "ğŸ§¹ æ­£åœ¨æ¸…ç†ç”Ÿæˆçš„æ•°æ®..."
	rm -rf data/processed/*
	rm -rf models/*
	rm -rf reports/*
	@echo "âœ… æ¸…ç†å®Œæˆ"


# æŸ¥çœ‹å¸®åŠ©
help:
	@echo "å¯ç”¨å‘½ä»¤ï¼š"
	@echo ""
	@echo "  make data"
	@echo "      - è·å–æ•°æ®"
	@echo "      - å¯åŠ  SKIP_DATA=true è·³è¿‡ï¼ˆè‹¥æ•°æ®å·²å­˜åœ¨ï¼‰"
	@echo ""
	@echo "  make features"
	@echo "      - ç‰¹å¾å·¥ç¨‹"
	@echo "      - å¯åŠ  SKIP_DATA=true è·³è¿‡ data æ­¥éª¤"
	@echo ""
	@echo "  make model"
	@echo "      - è®­ç»ƒæ¨¡å‹ï¼ˆä½¿ç”¨é»˜è®¤å‚æ•°ï¼‰"
	@echo "      - ç¤ºä¾‹ï¼šmake model N_ESTIMATORS=150 MAX_DEPTH=8 SKIP_DATA=true SKIP_FEATURES=true"
	@echo ""
	@echo "  make evaluate"
	@echo "      - è¯„ä¼°æ¨¡å‹"
	@echo "      - æ”¯æŒå‚æ•°å’Œ SKIP_DATA=true SKIP_FEATURES=true SKIP_MODEL=true"
	@echo ""
	@echo "  make sweep"
	@echo "      - å¤šå‚æ•°æ‰«æè®­ç»ƒ"
	@echo "      - æ”¯æŒ SKIP_DATA=true SKIP_FEATURES=true"
	@echo ""
	@echo "  make all"
	@echo "      - å®Œæ•´æµæ°´çº¿"
	@echo "      - æ”¯æŒ SKIP_DATA å’Œ SKIP_FEATURES"
	@echo ""
	@echo "  make clean"
	@echo "      - æ¸…ç†ç”Ÿæˆæ–‡ä»¶"
	@echo ""
	@echo "  make help"
	@echo "      - æŸ¥çœ‹å¸®åŠ©"
	@echo ""
	@echo "ğŸ’¡ æç¤ºï¼šç¡®ä¿å·²å®‰è£…ä¾èµ–ï¼špip install -r requirements.txt"
	@echo "ğŸ’¡ å½“å‰ä½¿ç”¨ Python: $(PYTHON)"